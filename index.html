<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanove Music</title>
    
    <!-- ICONS -->
    <link rel="icon" id="favicon" href="https://n.uguu.se/olrRLQVZ.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" id="appleIcon" href="https://n.uguu.se/olrRLQVZ.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <!-- LIBS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap');
        
        html, body { height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; font-family: 'Outfit', sans-serif; background: #000; color: white; -webkit-tap-highlight-color: transparent; user-select: none; }
        .scroll-area { overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fs-overlay { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); will-change: transform; z-index: 200; }
        .fs-overlay.active { transform: translateY(0); }
        input[type=range] { -webkit-appearance: none; background: transparent; height: 20px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #333; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 0; height: 0; box-shadow: -100vw 0 0 100vw #a855f7; background: #fff; }
        #fsSeek::-webkit-slider-thumb { width: 12px; height: 12px; border-radius: 50%; background: white; margin-top: -4px; box-shadow: none; -webkit-appearance: none; }
        .lyrics-line { transition: all 0.3s ease; opacity: 0.5; padding: 8px 0; transform-origin: left; cursor: pointer; }
        .lyrics-line.active { opacity: 1; transform: scale(1.05); color: #a855f7; font-weight: bold; text-shadow: 0 0 15px rgba(168, 85, 247, 0.3); }
    </style>
</head>
<body class="fixed inset-0">

    <!-- LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 z-[300] bg-black flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1614149162883-504ce4d13909?q=80&w=2000&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        <div class="bg-[#121212] border border-[#333] p-8 rounded-2xl w-full max-w-md text-center shadow-2xl relative z-10">
            <img id="loginLogo" src="https://n.uguu.se/olrRLQVZ.jpg" class="w-24 h-24 rounded-full mb-4 shadow-lg border-2 border-purple-500/30 object-cover mx-auto">
            <h1 class="text-2xl font-bold mb-6">Shanove Music</h1>
            
            <div id="emailForm" class="relative z-10 text-left">
                <input type="email" id="emailInput" placeholder="Masukan Email..." class="w-full bg-[#1e1e1e] text-white p-3 rounded-xl mb-3 outline-none border border-[#333] focus:border-purple-500 text-center">
                <button onclick="sendOTP()" id="btnSend" class="w-full bg-white hover:bg-gray-200 text-black font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">Masuk / Daftar</button>
            </div>

            <div id="otpForm" class="hidden relative z-10 text-left">
                <p class="text-center text-gray-400 mb-2 text-xs">Kode dikirim ke <b id="targetEmail"></b></p>
                <input type="number" id="otpInput" placeholder="000000" class="w-full bg-[#1e1e1e] text-white p-3 rounded-xl mb-3 outline-none text-center tracking-[0.5em] text-xl font-bold border border-[#333] focus:border-purple-500">
                <button onclick="verifyOTP()" id="btnVerify" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl mb-3 shadow-lg transition-transform active:scale-95">Verifikasi</button>
                <div class="text-center"><button onclick="location.reload()" class="text-xs text-gray-500 hover:text-white underline">Ubah Email</button></div>
            </div>
        </div>
    </div>

    <!-- AUDIO LOADER -->
    <div id="audioLoader" class="fixed top-24 left-1/2 -translate-x-1/2 bg-[#222]/90 border border-purple-500/50 text-white px-5 py-2 rounded-full shadow-2xl z-[250] hidden flex items-center gap-3 backdrop-blur-md">
        <i class="fas fa-circle-notch fa-spin text-purple-500"></i>
        <span class="text-xs font-bold">Memuat Audio...</span>
    </div>

    <!-- MENU MODAL -->
    <div id="menuModal" class="fixed inset-0 z-[260] bg-black/80 hidden flex flex-col justify-end" onclick="closeMenu()">
        <div class="bg-[#1a1a1a] rounded-t-2xl p-6 animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex items-center gap-4 mb-6 border-b border-[#333] pb-4">
                <img id="menuThumb" src="" class="w-12 h-12 rounded bg-gray-800 object-cover">
                <div>
                    <h3 id="menuTitle" class="font-bold text-sm truncate w-48">Title</h3>
                    <p id="menuArtist" class="text-xs text-gray-400">Artist</p>
                </div>
            </div>
            <div class="space-y-2">
                <button onclick="downloadCurrentSong()" class="w-full flex items-center gap-4 p-3 hover:bg-[#333] rounded-lg transition text-left">
                    <i class="fas fa-download text-gray-400 w-6"></i> <span>Download Audio</span>
                </button>
                <button onclick="closeMenu()" class="w-full flex items-center gap-4 p-3 hover:bg-[#333] rounded-lg transition text-left text-red-500">
                    <i class="fas fa-times w-6"></i> <span>Tutup</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="flex flex-col h-full w-full">
        <div class="flex-1 bg-[#0a0a0a] relative w-full scroll-area pb-[140px]" id="mainContainer">
            
            <!-- HOME -->
            <div id="pageHome" class="min-h-full p-4">
                <div class="flex items-center justify-between mb-6 pt-2">
                    <div class="flex items-center gap-3">
                        <img id="homeProfilePic" src="https://n.uguu.se/olrRLQVZ.jpg" class="w-9 h-9 rounded-full border border-white/20 object-cover cursor-pointer" onclick="switchPage('Profile')">
                        <div>
                            <p class="text-[10px] text-gray-400">Halo,</p>
                            <h1 id="homeUsername" class="text-md font-bold truncate w-32">User</h1>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-900 to-blue-900 rounded-2xl p-6 mb-8 relative overflow-hidden border border-white/10 shadow-lg">
                    <div class="relative z-10">
                        <h1 class="text-2xl font-bold mb-2">Shanove Sync</h1>
                        <p class="text-gray-200 text-sm mb-4">Profil tersimpan di Cloud.</p>
                        <button onclick="searchMusic('Top Hits Indonesia 2025')" class="bg-white text-black px-6 py-2 rounded-full text-sm font-bold hover:scale-105 transition">Play Hits</button>
                    </div>
                    <i class="fas fa-cloud absolute -right-4 -bottom-4 text-8xl text-white/10 rotate-12"></i>
                </div>

                <h2 class="font-bold text-lg mb-4">Playlist Pilihan</h2>
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div onclick="searchMusic('Phonk Aggressive')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-purple-900 rounded flex items-center justify-center">üèéÔ∏è</div><span class="text-sm font-bold">Phonk</span></div>
                    <div onclick="searchMusic('Galau Indonesia')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-blue-900 rounded flex items-center justify-center">üò¢</div><span class="text-sm font-bold">Galau</span></div>
                    <div onclick="searchMusic('DJ TikTok Viral')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-red-900 rounded flex items-center justify-center">üî•</div><span class="text-sm font-bold">TikTok</span></div>
                    <div onclick="searchMusic('Lofi Sleep')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-indigo-900 rounded flex items-center justify-center">üí§</div><span class="text-sm font-bold">Sleep</span></div>
                    <div onclick="searchMusic('J-Pop Anime')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-pink-900 rounded flex items-center justify-center">‚õ©Ô∏è</div><span class="text-sm font-bold">Anime</span></div>
                    <div onclick="searchMusic('Western Hits 2025')" class="bg-[#181818] p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-[#222] active:scale-95 transition"><div class="w-10 h-10 bg-green-900 rounded flex items-center justify-center">üåç</div><span class="text-sm font-bold">Barat</span></div>
                </div>
            </div>

            <!-- SEARCH -->
            <div id="pageSearch" class="hidden min-h-full p-4">
                 <div class="sticky top-0 bg-[#0a0a0a]/95 backdrop-blur z-30 pb-4 pt-2">
                    <h1 class="text-xl font-bold mb-4">Pencarian</h1>
                    <div class="relative w-full">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                        <input type="text" id="searchInput" placeholder="Cari lagu / artis..." class="w-full bg-[#1f1f1f] text-white pl-10 pr-4 py-3 rounded-full outline-none focus:bg-[#2a2a2a] text-sm border border-transparent focus:border-[#333]" onkeypress="if(event.key === 'Enter') searchMusic(this.value)">
                    </div>
                </div>
                <div id="searchLoading" class="hidden flex flex-col items-center justify-center py-20">
                    <i class="fas fa-spinner fa-spin text-3xl text-purple-500 mb-4"></i>
                    <p class="text-gray-500 text-xs mt-2">Mencari di iTunes...</p>
                </div>
                <div id="trackGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pb-20"></div>
            </div>

            <!-- PROFILE -->
            <div id="pageProfile" class="hidden min-h-full p-4">
                <h1 class="text-xl font-bold mb-6 pt-2">Profil Saya</h1>
                <div class="flex flex-col items-center justify-center mb-8">
                    <div class="relative group">
                        <img id="profilePicLarge" src="https://n.uguu.se/olrRLQVZ.jpg" class="w-28 h-28 rounded-full border-4 border-[#222] shadow-xl object-cover mb-4">
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="document.getElementById('editAvatarInput').focus()">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    <h2 id="profileNameDisplay" class="text-2xl font-bold">User</h2>
                    <p id="profileEmailDisplay" class="text-sm text-gray-400">user@email.com</p>
                </div>
                <div class="bg-[#181818] p-6 rounded-2xl border border-[#333] space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Username</label>
                        <input type="text" id="editUsernameInput" class="w-full bg-[#222] text-white p-3 rounded-lg outline-none border border-transparent focus:border-purple-500 mt-1">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Link Foto Profil (URL)</label>
                        <input type="text" id="editAvatarInput" class="w-full bg-[#222] text-white p-3 rounded-lg outline-none border border-transparent focus:border-purple-500 mt-1" placeholder="https://...">
                    </div>
                    <button onclick="saveProfile()" id="btnSaveProfile" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition">Simpan Perubahan</button>
                </div>
                <button onclick="logout()" class="w-full mt-6 py-3 rounded-lg border border-red-900/50 text-red-500 hover:bg-red-900/10 font-bold transition">Logout</button>
            </div>
        </div>

        <!-- NAVBAR -->
        <div class="fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur border-t border-[#222] h-[60px] flex items-center justify-around z-40 pb-safe">
            <div onclick="switchPage('Home')" class="flex flex-col items-center justify-center w-full h-full text-purple-500 cursor-pointer active:scale-95 transition" id="navHome">
                <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">Home</span>
            </div>
            <div onclick="switchPage('Search')" class="flex flex-col items-center justify-center w-full h-full text-gray-500 cursor-pointer active:scale-95 transition" id="navSearch">
                <i class="fas fa-search text-xl mb-1"></i><span class="text-[10px]">Cari</span>
            </div>
            <div onclick="switchPage('Profile')" class="flex flex-col items-center justify-center w-full h-full text-gray-500 cursor-pointer active:scale-95 transition" id="navProfile">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px]">Profil</span>
            </div>
        </div>

        <!-- MINI PLAYER -->
        <div id="playerBar" class="fixed bottom-[60px] w-full h-[65px] bg-[#111] border-t border-[#222] px-3 flex items-center justify-between z-50 shadow-lg cursor-pointer hidden" onclick="openFullscreen()">
            <div class="flex items-center w-[70%] gap-3 overflow-hidden">
                <img id="miniThumb" src="" class="w-10 h-10 rounded bg-[#222] object-cover flex-shrink-0">
                <div class="overflow-hidden">
                    <h4 id="miniTitle" class="text-sm font-bold text-white truncate">Title</h4>
                    <p id="miniArtist" class="text-xs text-gray-400 truncate">Artist</p>
                </div>
            </div>
            <div class="flex items-center gap-4 pr-2">
                <button onclick="event.stopPropagation(); togglePlay()" class="w-9 h-9 flex items-center justify-center bg-white text-black rounded-full shadow active:scale-90 transition"><i id="playIconMini" class="fas fa-play text-xs ml-0.5"></i></button>
            </div>
            <div class="absolute top-0 left-0 w-full h-[2px] bg-[#333]"><div id="progressMini" class="h-full bg-purple-500 w-0"></div></div>
        </div>
    </div>

    <!-- FULLSCREEN PLAYER -->
    <div id="fsOverlay" class="fs-overlay fixed inset-0 z-[200] bg-[#050505] flex flex-col h-full w-full">
        <div class="flex justify-between items-center p-6 relative z-20 shrink-0">
            <button onclick="closeFullscreen()" class="text-white w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center active:bg-white/20"><i class="fas fa-chevron-down"></i></button>
            <span class="text-xs font-bold tracking-[0.2em] text-purple-300">NOW PLAYING</span>
            <button onclick="openMenu()" class="text-white w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center active:bg-white/20 z-[220] pointer-events-auto"><i class="fas fa-ellipsis-v"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-6 relative z-10 scroll-area">
            <div class="fixed inset-0 z-[-1] opacity-30 pointer-events-none"><img id="fsBg" class="w-full h-full object-cover blur-[100px] scale-110"></div>
            
            <div class="w-full aspect-square rounded-2xl shadow-2xl mb-8 overflow-hidden bg-[#222] mx-auto max-w-xs mt-2">
                <img id="fsThumb" src="" class="w-full h-full object-cover">
            </div>
            
            <div class="w-full mb-6 mx-auto max-w-xs">
                <h1 id="fsTitle" class="text-2xl font-bold text-white leading-tight mb-1">No Song</h1>
                <p id="fsArtist" class="text-lg text-gray-400">Select a song...</p>
            </div>
            
            <div class="w-full mb-6 mx-auto max-w-xs">
                <input type="range" id="fsSeek" value="0" max="100" class="w-full cursor-pointer" oninput="seekInput(this.value)" onchange="seekChange(this.value)">
                <div class="flex justify-between w-full text-xs text-gray-300 mt-2 font-mono"><span id="timeFs">0:00</span><span id="durFs">0:00</span></div>
            </div>
            
            <div class="flex items-center justify-between w-full mx-auto max-w-xs mb-10">
                <button onclick="toggleShuffle()" id="btnShuffle" class="text-gray-400 transition active:scale-90"><i class="fas fa-shuffle text-xl"></i></button>
                <button onclick="prevSong()" class="text-white text-4xl active:text-purple-400 transition transform active:scale-90"><i class="fas fa-backward-step"></i></button>
                <button onclick="togglePlay()" class="w-20 h-20 bg-white rounded-full text-black flex items-center justify-center text-3xl shadow-lg transform active:scale-90 transition"><i id="playIconFs" class="fas fa-play ml-1"></i></button>
                <button onclick="nextSong()" class="text-white text-4xl active:text-purple-400 transition transform active:scale-90"><i class="fas fa-forward-step"></i></button>
                <button onclick="toggleRepeat()" id="btnRepeat" class="text-gray-400 transition active:scale-90"><i class="fas fa-repeat text-xl"></i></button>
            </div>

            <!-- LYRICS -->
            <div class="w-full mx-auto max-w-sm bg-black/20 rounded-2xl p-6 backdrop-blur-md mb-8 min-h-[300px] border border-white/5">
                <h3 class="font-bold text-gray-400 mb-4 text-xs uppercase tracking-widest text-center">Lirik</h3>
                <div id="lyricsContainer" class="flex flex-col gap-4 text-center font-bold text-lg h-[250px] overflow-y-auto no-scrollbar scroll-smooth">
                    <p class="text-gray-500 text-sm mt-10">Putar lagu untuk melihat lirik...</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="auto" playsinline></audio>

    <script>
        // CONFIG
        const API_KEY = "RS-e5vtb61yow";
        const EMAILJS_KEY = "0eVdYs-0usPaFRNPf"; 
        const EMAILJS_SERVICE = "service_rlpso0c";  
        const EMAILJS_TEMPLATE = "template_6ylv3rq";

        // FIREBASE SETUP
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';

        // --- AUTH & PROFILE SYNC ---
        let currentUserEmail = "";

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
            const savedEmail = localStorage.getItem('shanove_email');
            if(savedEmail) {
                currentUserEmail = savedEmail;
                document.getElementById('loginOverlay').classList.add('hidden');
                loadUserProfile(savedEmail);
            }
        };
        initAuth();

        function sendOTP() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const btn = document.getElementById('btnSend');
            if(!email.includes('@')) return alert("Email salah");
            
            const otp = Math.floor(100000 + Math.random() * 900000);
            btn.innerText = "Mengirim..."; btn.disabled = true;
            
            // PAYLOAD ANTI-MACET: Kirim dengan 3 key biar template manapun masuk
            const templateParams = {
                to_email: email,
                email: email,
                otp_code: otp,
                otp: otp,
                message: otp
            };
            
            // PENTING: Pass KEY sebagai parameter ke-4 biar gak cuma ngandelin init()
            emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, templateParams, EMAILJS_KEY)
                .then(() => {
                    document.getElementById('emailForm').classList.add('hidden');
                    document.getElementById('otpForm').classList.remove('hidden');
                    document.getElementById('targetEmail').innerText = email;
                    sessionStorage.setItem('otp', otp);
                    sessionStorage.setItem('temp_email', email);
                })
                .catch((err) => { 
                    console.error("EmailJS Error:", err);
                    alert("Gagal kirim: " + (err.text || "Cek Koneksi")); 
                    btn.innerText = "Masuk / Daftar"; 
                    btn.disabled = false; 
                });
        }

        function verifyOTP() {
            const input = document.getElementById('otpInput').value;
            // Backdoor 000000
            if(input == sessionStorage.getItem('otp') || input == "000000") {
                const email = sessionStorage.getItem('temp_email');
                localStorage.setItem('shanove_email', email);
                currentUserEmail = email;
                loadUserProfile(email);
                document.getElementById('loginOverlay').classList.add('hidden');
            } else alert("Kode Salah");
        }

        async function loadUserProfile(email) {
            if(!auth.currentUser) return;
            const docId = email.replace(/\./g, '_');
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(docId);
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    updateProfileUI(data.username, data.avatar, email);
                } else {
                    const defaultData = { username: email.split('@')[0], avatar: "https://n.uguu.se/olrRLQVZ.jpg" };
                    await docRef.set(defaultData);
                    updateProfileUI(defaultData.username, defaultData.avatar, email);
                }
            } catch (e) { console.error("Sync Error:", e); }
        }

        async function saveProfile() {
            if(!currentUserEmail) return;
            const newName = document.getElementById('editUsernameInput').value;
            const newAv = document.getElementById('editAvatarInput').value;
            const btn = document.getElementById('btnSaveProfile');
            
            btn.innerText = "Menyimpan..."; btn.disabled = true;
            const docId = currentUserEmail.replace(/\./g, '_');
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(docId);
            
            try {
                await docRef.set({ username: newName, avatar: newAv || "https://n.uguu.se/olrRLQVZ.jpg" }, { merge: true });
                updateProfileUI(newName, newAv, currentUserEmail);
                alert("Profil Tersimpan!");
            } catch(e) { alert("Gagal simpan."); } 
            finally { btn.innerText = "Simpan Perubahan"; btn.disabled = false; }
        }

        function updateProfileUI(name, avatar, email) {
            document.getElementById('homeUsername').innerText = name;
            document.getElementById('homeProfilePic').src = avatar || "https://n.uguu.se/olrRLQVZ.jpg";
            document.getElementById('profileNameDisplay').innerText = name;
            document.getElementById('profileEmailDisplay').innerText = email;
            document.getElementById('profilePicLarge').src = avatar || "https://n.uguu.se/olrRLQVZ.jpg";
            document.getElementById('editUsernameInput').value = name;
            document.getElementById('editAvatarInput').value = avatar;
            document.getElementById('favicon').href = avatar || "https://n.uguu.se/olrRLQVZ.jpg";
            document.getElementById('loginLogo').src = avatar || "https://n.uguu.se/olrRLQVZ.jpg";
        }

        function logout() { localStorage.removeItem('shanove_email'); location.reload(); }
        function resetLogin() { location.reload(); }

        function switchPage(page) {
            document.getElementById('pageHome').classList.add('hidden');
            document.getElementById('pageSearch').classList.add('hidden');
            document.getElementById('pageProfile').classList.add('hidden');
            document.getElementById('page' + page).classList.remove('hidden');
            ['Home', 'Search', 'Profile'].forEach(p => document.getElementById('nav'+p).className = "flex flex-col items-center justify-center w-full h-full text-gray-500 cursor-pointer active:scale-95 transition");
            document.getElementById('nav' + page).className = "flex flex-col items-center justify-center w-full h-full text-purple-500 cursor-pointer active:scale-95 transition";
        }

        // --- MUSIC ENGINE ---
        const audio = document.getElementById('audioPlayer');
        let queue = [];
        let curIndex = -1;
        let isSeeking = false;
        let isShuffle = false;
        let repeatMode = 0;
        let syncedLyrics = [];

        async function searchMusic(query) {
            if(!query) return;
            switchPage('Search');
            document.getElementById('searchInput').value = query;
            const loader = document.getElementById('searchLoading');
            const grid = document.getElementById('trackGrid');
            loader.classList.remove('hidden');
            grid.innerHTML = "";

            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=60`);
                const data = await res.json();
                const uniqueTitles = new Set();
                queue = data.results.filter(t => {
                    const clean = t.trackName.toLowerCase().trim();
                    if(uniqueTitles.has(clean)) return false;
                    uniqueTitles.add(clean);
                    return true;
                }).map(t => ({
                    title: t.trackName,
                    artist: t.artistName,
                    thumb: t.artworkUrl100 ? t.artworkUrl100.replace('100x100', '600x600') : 'https://via.placeholder.com/600',
                    preview: t.previewUrl,
                    fullAudio: null
                }));
                renderGrid();
            } catch (e) { console.error(e); } 
            finally { loader.classList.add('hidden'); }
        }

        function renderGrid() {
            document.getElementById('trackGrid').innerHTML = queue.map((t, i) => `
                <div onclick="processAndPlay(${i})" class="bg-[#181818] p-3 rounded-xl hover:bg-[#252525] transition cursor-pointer group active:scale-95">
                    <div class="relative mb-2 aspect-square rounded-lg overflow-hidden bg-[#222]">
                        <img src="${t.thumb}" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-white text-sm truncate leading-tight">${t.title}</h3>
                    <p class="text-gray-400 text-xs truncate">${t.artist}</p>
                </div>
            `).join('');
        }

        async function processAndPlay(index) {
            if(index < 0 || index >= queue.length) return;
            curIndex = index;
            const track = queue[index];

            updatePlayerUI(track);
            document.getElementById('playerBar').classList.remove('hidden');
            document.getElementById('audioLoader').classList.remove('hidden');
            syncedLyrics = [];
            renderLyrics(null);
            updateMediaSession(track);

            try {
                fetchLyrics(track.artist, track.title);

                let audioUrl = track.fullAudio;
                if (!audioUrl) {
                    let q = `${track.artist} - ${track.title}`;
                    let sRes = await fetch(`https://api.ferdev.my.id/search/spotify?query=${encodeURIComponent(q)}&apikey=${API_KEY}`);
                    let sJson = await sRes.json();
                    
                    if(!sJson.result || sJson.result.length === 0) {
                         sRes = await fetch(`https://api.ferdev.my.id/search/spotify?query=${encodeURIComponent(track.title)}&apikey=${API_KEY}`);
                         sJson = await sRes.json();
                    }

                    if(sJson.result && sJson.result.length > 0) {
                        const dlRes = await fetch(`https://api.ferdev.my.id/downloader/spotify?link=${sJson.result[0].url}&apikey=${API_KEY}`);
                        const dlJson = await dlRes.json();
                        if(dlJson.download) {
                            audioUrl = dlJson.download;
                            queue[index].fullAudio = audioUrl;
                        } else throw new Error("DL Fail");
                    } else throw new Error("Not Found");
                }
                
                audio.src = audioUrl;
                audio.play();
                updateIcons(true);

            } catch (e) {
                console.warn("Audio Error", e);
                if(track.preview) {
                    audio.src = track.preview;
                    audio.play();
                    updateIcons(true);
                } else {
                    setTimeout(() => nextSong(), 1000);
                }
            } finally {
                document.getElementById('audioLoader').classList.add('hidden');
            }
        }

        async function fetchLyrics(artist, title) {
            try {
                const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(artist + ' ' + title)}`);
                const json = await res.json();
                const match = json.find(i => i.syncedLyrics);
                if(match && match.syncedLyrics) parseLRC(match.syncedLyrics);
                else renderLyrics("Lirik tidak tersedia.");
            } catch (e) { renderLyrics("Gagal memuat lirik."); }
        }

        function parseLRC(lrc) {
            const lines = lrc.split('\n');
            syncedLyrics = [];
            const regex = /^\[(\d{2}):(\d{2}(?:\.\d+)?)\](.*)/;
            for(const line of lines) {
                const m = line.match(regex);
                if(m) syncedLyrics.push({ time: parseInt(m[1]) * 60 + parseFloat(m[2]), text: m[3].trim() });
            }
            renderLyrics(syncedLyrics);
        }

        function renderLyrics(data) {
            const container = document.getElementById('lyricsContainer');
            if(typeof data === 'string' || !data) {
                container.innerHTML = `<p class="text-gray-500 text-sm mt-10">${data || "Memuat..."}</p>`;
                return;
            }
            container.innerHTML = syncedLyrics.map((l, i) => 
                `<p id="line-${i}" class="lyrics-line text-lg font-medium text-gray-400" onclick="seek(${l.time})">${l.text}</p>`
            ).join('');
        }

        audio.addEventListener('timeupdate', () => {
            if(!isSeeking && audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressMini').style.width = pct + "%";
                document.getElementById('fsSeek').value = pct;
                document.getElementById('timeFs').innerText = formatTime(audio.currentTime);
                document.getElementById('durFs').innerText = formatTime(audio.duration);

                if(syncedLyrics.length > 0) {
                    let activeIndex = -1;
                    for(let i = 0; i < syncedLyrics.length; i++) {
                        if(audio.currentTime >= syncedLyrics[i].time) activeIndex = i; else break;
                    }
                    if(activeIndex !== -1) {
                        document.querySelectorAll('.lyrics-line').forEach(el => el.className = "lyrics-line text-lg font-medium text-gray-400");
                        const activeEl = document.getElementById(`line-${activeIndex}`);
                        if(activeEl) {
                            activeEl.className = "lyrics-line active text-xl font-bold text-white pl-2 border-l-4 border-purple-500";
                            activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }
        });

        function updatePlayerUI(t) {
            document.getElementById('miniTitle').innerText = t.title;
            document.getElementById('miniArtist').innerText = t.artist;
            document.getElementById('miniThumb').src = t.thumb;
            document.getElementById('fsTitle').innerText = t.title;
            document.getElementById('fsArtist').innerText = t.artist;
            document.getElementById('fsThumb').src = t.thumb;
            document.getElementById('fsBg').src = t.thumb;
            document.getElementById('menuTitle').innerText = t.title;
            document.getElementById('menuArtist').innerText = t.artist;
            document.getElementById('menuThumb').src = t.thumb;
        }

        function updateMediaSession(t) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: t.title, artist: t.artist, artwork: [{ src: t.thumb, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
            }
        }

        function togglePlay() {
            if(audio.paused) { audio.play(); updateIcons(true); } 
            else { audio.pause(); updateIcons(false); }
        }
        function updateIcons(isPlaying) {
            const cls = isPlaying ? "fa-pause" : "fa-play";
            document.getElementById('playIconMini').className = `fas ${cls} text-xs ml-0.5`;
            document.getElementById('playIconFs').className = `fas ${cls} ml-1`;
        }
        function nextSong() {
            if (queue.length === 0) return;
            let nextIndex = isShuffle ? Math.floor(Math.random() * queue.length) : curIndex + 1;
            if (repeatMode === 2) nextIndex = curIndex;
            else if (nextIndex >= queue.length) {
                if(repeatMode === 1) nextIndex = 0; else return;
            }
            processAndPlay(nextIndex);
        }
        function prevSong() {
            if (queue.length === 0) return;
            let prevIndex = curIndex - 1;
            if (prevIndex < 0) prevIndex = queue.length - 1;
            processAndPlay(prevIndex);
        }
        
        audio.addEventListener('ended', nextSong);
        audio.addEventListener('error', () => setTimeout(nextSong, 2000));

        function toggleShuffle() { isShuffle = !isShuffle; document.getElementById('btnShuffle').className = isShuffle ? "text-purple-500" : "text-gray-400"; }
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const btn = document.getElementById('btnRepeat');
            if (repeatMode === 0) { btn.className = "text-gray-400"; btn.innerHTML = '<i class="fas fa-repeat text-xl"></i>'; }
            else if (repeatMode === 1) { btn.className = "text-purple-500"; btn.innerHTML = '<i class="fas fa-repeat text-xl"></i>'; }
            else { btn.className = "text-purple-500"; btn.innerHTML = '<div class="relative"><i class="fas fa-repeat text-xl"></i><span class="absolute -top-1 -right-1 text-[8px] font-bold bg-white text-black px-1 rounded-full">1</span></div>'; }
        }

        window.seekInput = (val) => { isSeeking = true; };
        window.seekChange = (val) => { isSeeking = false; if(audio.duration) audio.currentTime = (val/100) * audio.duration; };
        function seek(time) { if(audio.src) audio.currentTime = time; }
        function formatTime(s) { if(isNaN(s)) return "0:00"; const m = Math.floor(s/60), sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }

        function openFullscreen() { if(audio.src) document.getElementById('fsOverlay').classList.add('active'); }
        function closeFullscreen() { document.getElementById('fsOverlay').classList.remove('active'); }
        function openMenu() { document.getElementById('menuModal').classList.remove('hidden'); }
        function closeMenu() { document.getElementById('menuModal').classList.add('hidden'); }
        
        function downloadCurrentSong() {
            if(curIndex >= 0 && queue[curIndex].fullAudio) window.open(queue[curIndex].fullAudio, '_blank');
            closeMenu();
        }
    </script>
</body>
</html>



